<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PriceFirstNow - Instant Price Ranges</title>
  <meta name="description" content="Instant local price ranges for remodeling, cleaning, plumbing, HVAC, and pet care in Palm Beach and Broward County." />

  <style>
    :root{
      --bg:#070b34;
      --text:#ffffff;
      --muted:#c7d2fe;
      --border:rgba(255,255,255,.16);
      --shadow:0 22px 70px rgba(0,0,0,.45);
      --accent:#22d3ee;
      --accent2:#a78bfa;
      --accent3:#34d399;
      --ink:#031018;
      --radius:22px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 650px at 10% -10%, rgba(34,211,238,.35), transparent),
        radial-gradient(900px 650px at 90% 0%, rgba(167,139,250,.35), transparent),
        radial-gradient(900px 650px at 70% 120%, rgba(52,211,153,.22), transparent),
        var(--bg);
      min-height:100vh;
    }

    a{color:inherit;text-decoration:none}

    .container{max-width:1180px;margin:0 auto;padding:22px}

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      padding:8px 0 18px;
    }

    .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.2px}
    .mark{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--shadow)}
    .brandName{font-size:18px}

    nav{display:flex;gap:14px;flex-wrap:wrap}
    nav a{font-weight:800;opacity:.9}
    nav a:hover{opacity:1;text-decoration:underline}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .hero{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:18px;
      align-items:stretch;
    }

    .heroLeft{padding:30px}
    .heroRight{padding:20px}

    h1{margin:0 0 12px;font-size:46px;line-height:1.05}
    h2{margin:0 0 10px;font-size:22px}
    h3{margin:0 0 6px}
    .muted{color:var(--muted);line-height:1.55}

    .ctaRow{display:flex;gap:12px;flex-wrap:wrap;margin-top:18px}

    .btn{
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:rgba(255,255,255,.10);
      color:var(--text);
      transition:transform .12s ease, opacity .12s ease;
    }

    .btn.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent3));
      border:0;
      color:var(--ink);
    }

    .btn.ghost{background:rgba(255,255,255,.10)}

    .btn:hover{transform:translateY(-1px);opacity:1}

    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .badge{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      font-weight:900;
      font-size:13px;
    }

    /* Quote panel */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(255,255,255,.10);
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
    }
    .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:var(--ink);border:0}

    form{display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    label{font-size:12px;font-weight:900;color:var(--muted)}

    input, select, textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color:rgba(34,211,238,.55)}

    textarea{min-height:86px;resize:vertical}

    .quoteBox{
      margin-top:12px;
      padding:16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.30);
    }
    .quoteAmt{font-size:26px;font-weight:1000;letter-spacing:.2px}
    .fine{color:var(--muted);font-size:13px;line-height:1.55;margin:0}

    /* Info grid */
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
    .mini{padding:16px}
    .mini p{margin:0;color:var(--muted);line-height:1.55}

    section{padding:20px;margin-top:18px;scroll-margin-top:90px}

    footer{margin:28px 0 8px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px}

    .hidden{display:none !important;}

    /* Mobile */
    @media (max-width:960px){
      .hero{grid-template-columns:1fr}
    }
    @media (max-width:640px){
      h1{font-size:34px}
      .heroLeft{padding:22px}
      .heroRight{padding:16px}
      .row2{grid-template-columns:1fr}
      .btn{width:100%}
      nav{justify-content:center}
      header{flex-direction:column;align-items:flex-start}
    }
    @media (max-width:560px){
      h1{font-size:36px;line-height:1.08}
      .ctaRow{flex-direction:column}
      .grid3{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <div class="brand">
      <div class="mark" aria-hidden="true"></div>
      <div class="brandName">PriceFirstNow</div>
    </div>
    <nav>
      <a href="#quote">Get Quote</a>
      <a href="#how">How it works</a>
      <a href="#providers">Providers</a>
      <a href="#contact">Contact</a>
    </nav>
  </header>

  <div class="hero">

    <section class="card heroLeft">
      <h1>See the price first.<br />Then choose your provider.</h1>
      <p class="muted">Instant price ranges for home services in Broward and Palm Beach County. No calls. No pressure.</p>

      <div class="ctaRow">
        <button class="btn primary" type="button" onclick="document.querySelector('#quote').scrollIntoView({behavior:'smooth'})">Get Instant Quote</button>
        <button class="btn ghost" type="button" onclick="document.querySelector('#providers').scrollIntoView({behavior:'smooth'})">Become a Provider</button>
      </div>

      <div class="ctaRow" style="margin-bottom:12px">
        <button class="btn ghost" type="button" id="downloadBtn">Download HTML</button>
      </div>

      <div class="badges">
        <div class="badge">60-second estimate</div>
        <div class="badge">Price-aware clients</div>
        <div class="badge">Local matching</div>
        <div class="badge">No bank info</div>
      </div>
    </section>

    <section class="card heroRight" id="quote">
      <div class="tabs" aria-label="Services">
        <button class="tab active" type="button" data-svc="cleaning">Cleaning</button>
        <button class="tab" type="button" data-svc="pet">Pet Care</button>
        <button class="tab" type="button" data-svc="remodel">Remodeling</button>
        <button class="tab" type="button" data-svc="plumbing">Plumbing</button>
        <button class="tab" type="button" data-svc="hvac">HVAC</button>
      </div>

      <h2 style="margin-top:0">Instant Price Estimate</h2>

      <form id="quoteForm">
        <div class="row2">
          <div>
            <label for="county">County</label>
            <select id="county" required>
              <option value="broward" selected>Broward</option>
              <option value="palmbeach">Palm Beach</option>
            </select>
          </div>
          <div>
            <label for="zip">ZIP Code</label>
            <input id="zip" inputmode="numeric" maxlength="5" placeholder="33063" required />
          </div>
        </div>

        <div>
          <label for="service">Service type</label>
          <select id="service"></select>
        </div>

        <div class="row2">
          <div>
            <label for="stories">Stories / access</label>
            <select id="stories">
              <option value="1-story / easy access" selected>1-story / easy access</option>
              <option value="2-story">2-story</option>
              <option value="3+ stories or condo">3+ stories or condo</option>
              <option value="difficult access">Difficult access</option>
            </select>
          </div>
          <div>
            <label for="prep">Prep / repairs needed</label>
            <select id="prep">
              <option value="none" selected>None</option>
              <option value="light (minor patching)">Light (minor patching)</option>
              <option value="medium (repairs)">Medium (repairs)</option>
              <option value="heavy (major repairs)">Heavy (major repairs)</option>
            </select>
          </div>
        </div>

        <div id="sizeWrap">
          <label for="size" id="sizeLabel">Area / size (sq ft)</label>
          <input id="size" inputmode="numeric" placeholder="e.g. 500" />
        </div>

        <div id="paintingScopeWrap" class="hidden">
          <label for="paintingScope">If painting: scope</label>
          <select id="paintingScope">
            <option value="Walls only" selected>Walls only</option>
            <option value="Walls + ceilings">Walls + ceilings</option>
            <option value="Ceilings only">Ceilings only</option>
            <option value="Trim / doors">Trim / doors</option>
            <option value="Full repaint">Full repaint</option>
          </select>
        </div>

        <div id="flooringMaterialWrap" class="hidden">
          <label for="flooringMaterial">Flooring material</label>
          <select id="flooringMaterial">
            <option value="Tile" selected>Tile</option>
            <option value="Wood">Wood</option>
            <option value="Natural stone">Natural stone</option>
            <option value="Laminate">Laminate</option>
            <option value="Carpet">Carpet</option>
          </select>
        </div>

        <div id="petOptionsWrap" class="hidden">
          <div class="row2">
            <div>
              <label for="petOption">Pet service option</label>
              <select id="petOption"></select>
            </div>
            <div>
              <label for="petCount">Number of pets</label>
              <select id="petCount">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4+</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="e.g., condo rules, access, materials already purchased..."></textarea>
        </div>

        <div class="row2">
          <div>
            <label for="needWhen">When do you need it?</label>
            <select id="needWhen">
              <option value="Flexible" selected>Flexible</option>
              <option value="ASAP">ASAP</option>
              <option value="Within 1 week">Within 1 week</option>
              <option value="Within 2-4 weeks">Within 2-4 weeks</option>
              <option value="1-2 months">1-2 months</option>
            </select>
          </div>
          <div>
            <label for="serviceLevel">Service level</label>
            <select id="serviceLevel">
              <option value="Standard" selected>Standard</option>
              <option value="Budget">Budget</option>
              <option value="Premium">Premium</option>
              <option value="Luxury">Luxury</option>
            </select>
          </div>
        </div>

        <button class="btn primary" style="width:100%" type="button" id="showBtn">Show Price Range</button>

        <div class="quoteBox" id="quoteBox" style="display:none">$1<div style="margin-top:10px">
            <button class="btn ghost" type="button" id="matchBtn">Get Matched</button>
          </div>
          <p class="fine" id="matchStatus" style="margin-top:8px"></p>
        </div>
      </form>
    </section>

  </div>

  <div class="grid3" id="how">
    <div class="card mini">
      <h3>1) Answer a few questions</h3>
      <p>We estimate based on size, service type, and local market ranges.</p>
    </div>
    <div class="card mini">
      <h3>2) Get a price range instantly</h3>
      <p>Transparent ranges help you avoid surprises and reduce wasted calls.</p>
    </div>
    <div class="card mini">
      <h3>3) Get matched with providers</h3>
      <p>We route your request to providers that match your area and service.</p>
    </div>
  </div>

  <section class="card" id="providers">
    <h2>Become a Provider</h2>
    <p class="muted">Get price-aware local leads. No monthly fee during launch.</p>

    <label for="pname">Name</label>
    <input id="pname" autocomplete="name" />

    <label for="pcompany" style="margin-top:10px">Company</label>
    <input id="pcompany" autocomplete="organization" />

    <label for="pemail" style="margin-top:10px">Email</label>
    <input id="pemail" type="email" autocomplete="email" />

    <button class="btn primary" style="margin-top:14px" type="button" onclick="providerApply()">Send Application</button>

    <p class="fine" style="margin-top:10px">This MVP uses email to collect provider signups. Later, we can add a real form and database.</p>
  </section>

  <section class="card" id="contact">
    <h2>Contact</h2>
    <p class="muted">Questions or early access?</p>
    <a id="contactLink" class="btn ghost" href="#">Email Us</a>
    <p class="fine" style="margin-top:10px">Email: <span id="adminEmailText" style="font-weight:900"></span></p>
    <p class="fine" style="margin-top:12px">Tip: In the footer, click Set admin email to change where leads are sent (no code editing needed).</p>
  </section>

  <footer>
    <div>&copy; <span id="year"></span> PriceFirstNow</div>
    <div><a href="#" id="setEmailLink" style="text-decoration:underline">Set admin email</a></div>
  </footer>

</div>

<!-- Netlify Forms (hidden lead form; no email/password popups) -->
<form name="lead" id="netlifyLeadForm" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="hidden">
  <input type="hidden" name="form-name" value="lead" />
  <p class="hidden"><label>Don’t fill this out: <input name="bot-field" /></label></p>
  <input type="text" name="leadName" />
  <input type="text" name="leadPhone" />
  <input type="email" name="leadEmail" />
  <input type="text" name="county" />
  <input type="text" name="zip" />
  <input type="text" name="category" />
  <input type="text" name="serviceType" />
  <input type="text" name="stories" />
  <input type="text" name="prep" />
  <input type="text" name="size" />
  <input type="text" name="paintingScope" />
  <input type="text" name="flooringMaterial" />
  <input type="text" name="petOption" />
  <input type="text" name="petCount" />
  <input type="text" name="needWhen" />
  <input type="text" name="serviceLevel" />
  <input type="text" name="estimateLow" />
  <input type="text" name="estimateHigh" />
  <textarea name="notes"></textarea>
</form>

<noscript>
  <div class="card" style="margin-top:18px;padding:18px">
    <h3>Get Matched (No JavaScript)</h3>
    <p class="muted">Enable JavaScript for the instant matching form to work.</p>
  </div>
</noscript>

<script>
  // Default email (editable via footer link)
  const DEFAULT_ADMIN_EMAIL = "pricefirstnow@gmail.com";
  let ADMIN_EMAIL = localStorage.getItem("PFN_ADMIN_EMAIL") || DEFAULT_ADMIN_EMAIL;

  // Multipliers (simple MVP)
  const COUNTY_MULT = { broward: 1.00, palmbeach: 1.08 };

  // Service lists (service type for all trades)
  const SERVICE_LIST = {
    cleaning: ["Residential", "Post Construction", "Office", "Commercial"],
    pet: ["Walking", "Sitting", "Wash and Haircut"],
    remodel: ["Interior Painting", "Exterior Painting", "Flooring", "Drywall", "Windows and Doors", "Carpentry", "Other"],
    plumbing: ["New Construction or Remodel", "Leak Detection", "Water Supply System", "Drain-Waste-Vent (DWV)", "Water Heaters", "Disposal Replacement", "Other"],
    hvac: ["Complete System Installation", "Ductwork", "Duct Cleaning", "Service and Repairs", "Preventive Maintenance", "Indoor Air Quality", "Controls and Energy Efficiency", "Commercial or Condo Work"]
  };

  // Pet options (pet size built into the option label)
  const PET_OPTIONS = {
    Walking: [
      { label: "30-minute walk (small pet)", value: "walk_30_s", low: 22, high: 40 },
      { label: "30-minute walk (medium pet)", value: "walk_30_m", low: 25, high: 45 },
      { label: "30-minute walk (large pet)", value: "walk_30_l", low: 30, high: 55 },
      { label: "60-minute walk (small pet)", value: "walk_60_s", low: 38, high: 65 },
      { label: "60-minute walk (medium pet)", value: "walk_60_m", low: 42, high: 75 },
      { label: "60-minute walk (large pet)", value: "walk_60_l", low: 50, high: 90 }
    ],
    Sitting: [
      { label: "Drop-in visit (small pet)", value: "sit_dropin_s", low: 28, high: 50 },
      { label: "Drop-in visit (medium pet)", value: "sit_dropin_m", low: 32, high: 60 },
      { label: "Drop-in visit (large pet)", value: "sit_dropin_l", low: 38, high: 70 },
      { label: "Overnight sitting (small pet)", value: "sit_overnight_s", low: 85, high: 150 },
      { label: "Overnight sitting (medium pet)", value: "sit_overnight_m", low: 95, high: 170 },
      { label: "Overnight sitting (large pet)", value: "sit_overnight_l", low: 110, high: 200 }
    ],
    "Wash and Haircut": [
      { label: "Small pet", value: "groom_small", low: 70, high: 120 },
      { label: "Medium pet", value: "groom_medium", low: 90, high: 160 },
      { label: "Large pet", value: "groom_large", low: 120, high: 220 }
    ]
  };

  let activeCategory = "cleaning";

  function money(n){
    return "$" + Math.round(Number(n)).toLocaleString();
  }

  function validateZip(v){
    return /^[0-9]{5}$/.test(String(v || "").trim());
  }

  function applyConfidenceBand(lo, hi){
    // Global narrowing (keeps ranges realistic but not crazy wide)
    return { lo: lo * 1.05, hi: hi * 0.80 };
  }

  function typicalBand(lo, hi){
    const span = Math.max(0, hi - lo);
    return { lo: lo + span * 0.35, hi: lo + span * 0.65 };
  }

  function isPaintingSubtype(){
    const subtype = String(document.getElementById("service").value || "").toLowerCase();
    return subtype.indexOf("painting") !== -1;
  }

  function isFlooringSubtype(){
    return String(document.getElementById("service").value || "") === "Flooring";
  }

  function isDisposalSubtype(){
    return String(document.getElementById("service").value || "") === "Disposal Replacement";
  }

  function isPetCategory(){
    return activeCategory === "pet";
  }

  function refreshPetOptions(){
    const wrap = document.getElementById("petOptionsWrap");
    const sel = document.getElementById("petOption");
    if(!wrap || !sel) return;

    if(!isPetCategory()){
      wrap.classList.add("hidden");
      return;
    }

    wrap.classList.remove("hidden");

    const subtype = document.getElementById("service").value;
    const opts = PET_OPTIONS[subtype] || [];

    sel.innerHTML = "";
    opts.forEach(function(o){
      const opt = document.createElement("option");
      opt.value = o.value;
      opt.textContent = o.label;
      sel.appendChild(opt);
    });

    if(!opts.length){
      const opt = document.createElement("option");
      opt.value = "default";
      opt.textContent = "Standard";
      sel.appendChild(opt);
    }
  }

  function hideQuote(){
    const qb = document.getElementById("quoteBox");
    if(qb) qb.style.display = "none";
  }

  function refreshConditionalFields(){
    const paintWrap = document.getElementById("paintingScopeWrap");
    if(paintWrap) paintWrap.classList.toggle("hidden", !isPaintingSubtype());

    const floorWrap = document.getElementById("flooringMaterialWrap");
    if(floorWrap) floorWrap.classList.toggle("hidden", !isFlooringSubtype());

    // Pet care: hide size/sqft field (not used)
    const sizeWrap = document.getElementById("sizeWrap");
    if(sizeWrap) sizeWrap.classList.toggle("hidden", isPetCategory());

    const sizeLabel = document.getElementById("sizeLabel");
    const sizeInput = document.getElementById("size");

    if(sizeLabel && sizeInput && !isPetCategory()){
      if(isDisposalSubtype()){
        sizeLabel.textContent = "Quantity";
        sizeInput.placeholder = "e.g. 1";
      } else {
        sizeLabel.textContent = "Area / size (sq ft)";
        sizeInput.placeholder = "e.g. 500";
      }
    }

    refreshPetOptions();
  }

  function setCategory(cat){
    activeCategory = cat;

    document.querySelectorAll(".tab").forEach(function(b){
      b.classList.toggle("active", b.dataset.svc === cat);
    });

    const sel = document.getElementById("service");
    sel.innerHTML = "";
    (SERVICE_LIST[cat] || []).forEach(function(name){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    refreshConditionalFields();
    hideQuote();
  }

  function calculate(){
    const county = document.getElementById("county").value;
    const zip = document.getElementById("zip").value.trim();

    if(!validateZip(zip)){
      alert("Please enter a 5-digit ZIP code.");
      return null;
    }

    const subtype = document.getElementById("service").value;

    const stories = document.getElementById("stories").value;
    const prep = document.getElementById("prep").value;
    const needWhen = document.getElementById("needWhen").value;
    const serviceLevel = document.getElementById("serviceLevel").value;
    const paintingScope = document.getElementById("paintingScope").value;
    const flooringMaterial = document.getElementById("flooringMaterial").value;
    const notes = document.getElementById("notes").value.trim();

    const rawSize = String(document.getElementById("size").value || "").trim();
    let size = Number(rawSize);

    // Pet care: no sqft/units required.
    if(isPetCategory()){
      size = 1;
    } else if(isDisposalSubtype()){
      if(!size || size < 1){
        size = 1;
        document.getElementById("size").value = "1";
      }
    } else {
      if(!size || size < 1){
        alert("Enter a realistic size.");
        return null;
      }
    }

    let low, high;

    if(isDisposalSubtype()){
      const qty = Math.max(1, size || 1);
      low = 250 * qty;
      high = 650 * qty;
    } else if(isPetCategory()){
      const petCountRaw = Number(document.getElementById("petCount").value || 1);
      const petCount = Math.max(1, petCountRaw >= 4 ? 4 : petCountRaw);

      const optionValue = document.getElementById("petOption").value;
      const options = PET_OPTIONS[subtype] || [];
      const found = options.find(function(o){ return o.value === optionValue; }) || options[0];

      const perLow = found ? found.low : 30;
      const perHigh = found ? found.high : 60;
      const extraPetMult = (petCount === 1) ? 1.00 : (petCount === 2 ? 1.35 : (petCount === 3 ? 1.60 : 1.80));

      low = perLow * extraPetMult;
      high = perHigh * extraPetMult;
    } else {
      // Simple sqft base for MVP
      low = size * 1.5;
      high = size * 3.5;
    }

    const svcMult = { cleaning: 1.0, pet: 1.0, remodel: 1.25, plumbing: 1.15, hvac: 1.4 };
    const m = svcMult[activeCategory] || 1.0;
    low *= m;
    high *= m;

    const accessMult = {
      "1-story / easy access": 1.00,
      "2-story": 1.06,
      "3+ stories or condo": 1.10,
      "difficult access": 1.14
    };
    low *= accessMult[stories] || 1.0;
    high *= accessMult[stories] || 1.0;

    const prepMult = {
      none: 1.00,
      "light (minor patching)": 1.05,
      "medium (repairs)": 1.12,
      "heavy (major repairs)": 1.22
    };
    low *= prepMult[prep] || 1.0;
    high *= prepMult[prep] || 1.0;

    const levelMult = { Budget: 0.92, Standard: 1.00, Premium: 1.12, Luxury: 1.25 };
    low *= levelMult[serviceLevel] || 1.0;
    high *= levelMult[serviceLevel] || 1.0;

    if(isFlooringSubtype()){
      const matMult = {
        Tile: 1.00,
        Wood: 1.12,
        "Natural stone": 1.35,
        Laminate: 0.85,
        Carpet: 0.80
      };
      const mm = matMult[flooringMaterial] || 1.0;
      low *= mm;
      high *= mm;
    }

    low *= COUNTY_MULT[county] || 1.0;
    high *= COUNTY_MULT[county] || 1.0;

    const c = applyConfidenceBand(low, high);
    low = c.lo;
    high = c.hi;

    return {
      low, high, county, zip,
      cat: activeCategory,
      subtype, stories, prep, needWhen, serviceLevel,
      paintingScope: isPaintingSubtype() ? paintingScope : "",
      flooringMaterial: isFlooringSubtype() ? flooringMaterial : "",
      petOption: isPetCategory() ? document.getElementById("petOption").value : "",
      petCount: isPetCategory() ? document.getElementById("petCount").value : "",
      notes
    };
  }

  function providerApply(){
    const name = document.getElementById("pname").value.trim();
    const company = document.getElementById("pcompany").value.trim();
    const email = document.getElementById("pemail").value.trim();

    if(!name || !email){
      alert("Please enter at least your name and email.");
      return;
    }

    const body = encodeURIComponent(
      "Provider application\n" +
      "Name: " + name + "\n" +
      "Company: " + company + "\n" +
      "Email: " + email + "\n"
    );

    window.location.href =
      "mailto:" + ADMIN_EMAIL +
      "?subject=" + encodeURIComponent("Provider Application") +
      "&body=" + body;
  }

  function encodeForm(data){
    return Object.keys(data)
      .map(function(k){ return encodeURIComponent(k) + "=" + encodeURIComponent(String(data[k] ?? "")); })
      .join("&");
  }

  function setMatchStatus(msg, isOk){
    const el = document.getElementById("matchStatus");
    if(!el) return;
    el.textContent = msg || "";
    el.style.color = isOk ? "#bbf7d0" : "#fecaca";
  }

  async function submitLeadToNetlify(payload){
    // Netlify Forms: POST urlencoded to the site root
    const body = encodeForm(payload);
    const res = await fetch("/", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });
    return res.ok;
  }

  function openMailto(subject, bodyText){
    // Kept for Contact button only (some users prefer email)
    const subjectEnc = encodeURIComponent(subject);
    const bodyEnc = encodeURIComponent(bodyText);
    const href = "mailto:" + ADMIN_EMAIL + "?subject=" + subjectEnc + "&body=" + bodyEnc;

    try{
      window.location.href = href;
    } catch(e) {
      // ignore
    }

    // Fallback message (some in-app browsers block mailto)
    setTimeout(function(){
      const msg = "If your email app didn't open, email us at: " + ADMIN_EMAIL;
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(ADMIN_EMAIL).then(function(){
            alert(msg + "

(Email copied to clipboard)");
          }).catch(function(){
            alert(msg);
          });
        } else {
          alert(msg);
        }
      } catch(err){
        alert(msg);
      }
    }, 350);
  }

  function refreshMailLinks(){
    const link = document.getElementById("contactLink");
    const txt = document.getElementById("adminEmailText");

    if(txt) txt.textContent = ADMIN_EMAIL;

    if(link){
      link.href = "mailto:" + ADMIN_EMAIL;
      link.onclick = function(e){
        e.preventDefault();
        openMailto(
          "PriceFirstNow Inquiry",
          "Hello, I have a question about PriceFirstNow.\n\nMy question: "
        );
        return false;
      };
    }
  }

  function setAdminEmail(){
    const next = prompt("Enter the email where you want to receive leads:", ADMIN_EMAIL);
    if(!next) return;
    ADMIN_EMAIL = next.trim();
    localStorage.setItem("PFN_ADMIN_EMAIL", ADMIN_EMAIL);
    refreshMailLinks();
    alert("Saved. Leads will be emailed to: " + ADMIN_EMAIL);
  }

  // Wire up UI
  document.querySelectorAll(".tab").forEach(function(btn){
    btn.addEventListener("click", function(){
      setCategory(btn.dataset.svc);
    });
  });

  document.getElementById("service").addEventListener("change", function(){
    refreshConditionalFields();
    hideQuote();
  });

  document.getElementById("petOption").addEventListener("change", hideQuote);
  document.getElementById("petCount").addEventListener("change", hideQuote);

  document.getElementById("county").addEventListener("change", hideQuote);
  document.getElementById("zip").addEventListener("input", hideQuote);
  document.getElementById("stories").addEventListener("change", hideQuote);
  document.getElementById("prep").addEventListener("change", hideQuote);
  document.getElementById("needWhen").addEventListener("change", hideQuote);
  document.getElementById("serviceLevel").addEventListener("change", hideQuote);
  document.getElementById("size").addEventListener("input", hideQuote);
  document.getElementById("flooringMaterial").addEventListener("change", hideQuote);
  document.getElementById("paintingScope").addEventListener("change", hideQuote);

  document.getElementById("showBtn").addEventListener("click", function(){
    const r = calculate();
    if(!r) return;

    const rangeText = money(r.low) + " - " + money(r.high);
    document.getElementById("result").innerText = rangeText;

    const t = typicalBand(r.low, r.high);
    document.getElementById("typical").innerText =
      "Most similar jobs land around " + money(t.lo) + " - " + money(t.hi);

    const ln = document.getElementById("leadName");
    const lp = document.getElementById("leadPhone");
    const le = document.getElementById("leadEmail");
    if(ln) ln.value = "";
    if(lp) lp.value = "";
    if(le) le.value = "";

    document.getElementById("quoteBox").style.display = "block";
  });

  document.getElementById("matchBtn").addEventListener("click", async function(){
    setMatchStatus("", true);

    const r = calculate();
    if(!r) return;

    const name = String(document.getElementById("leadName").value || "").trim();
    const phone = String(document.getElementById("leadPhone").value || "").trim();
    const email = String(document.getElementById("leadEmail").value || "").trim();

    if(!name){
      alert("Please enter your name.");
      document.getElementById("leadName").focus();
      return;
    }
    if(!phone){
      alert("Please enter your phone number.");
      document.getElementById("leadPhone").focus();
      return;
    }
    if(!email){
      alert("Email is required to get matched.");
      document.getElementById("leadEmail").focus();
      return;
    }
    if(email.indexOf("@") === -1 || email.indexOf(".") === -1){
      alert("Please enter a valid email address.");
      document.getElementById("leadEmail").focus();
      return;
    }

    // Build payload for Netlify Forms
    const payload = {
      "form-name": "lead",
      leadName: name,
      leadPhone: phone,
      leadEmail: email,
      county: r.county,
      zip: r.zip,
      category: r.cat,
      serviceType: r.subtype || "",
      stories: r.stories || "",
      prep: r.prep || "",
      size: (r.cat === "pet") ? "" : String(document.getElementById("size").value || ""),
      paintingScope: r.paintingScope || "",
      flooringMaterial: r.flooringMaterial || "",
      petOption: r.petOption || "",
      petCount: r.petCount || "",
      needWhen: r.needWhen || "",
      serviceLevel: r.serviceLevel || "",
      estimateLow: String(Math.round(r.low)),
      estimateHigh: String(Math.round(r.high)),
      notes: r.notes || ""
    };

    // UX: show instant feedback
    setMatchStatus("Sending…", true);

    try{
      const ok = await submitLeadToNetlify(payload);
      if(ok){
        setMatchStatus("✅ Submitted! A provider will contact you soon.", true);
      } else {
        setMatchStatus("⚠️ Submission failed. Please try again or use Contact → Email Us.", false);
      }
    } catch(err){
      setMatchStatus("⚠️ Submission blocked by browser/network. Please try again or use Contact → Email Us.", false);
    }
  });

  // Download current page as HTML file
  const downloadBtn = document.getElementById("downloadBtn");
  if(downloadBtn){
    downloadBtn.addEventListener("click", function(){
      const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML;
      const blob = new Blob([html], { type: "text/html;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "index.html";
      document.body.appendChild(a);
      a.click();

      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  // Init
  refreshMailLinks();
  document.getElementById("year").innerText = String(new Date().getFullYear());
  document.getElementById("setEmailLink").addEventListener("click", function(e){
    e.preventDefault();
    setAdminEmail();
  });

  setCategory("cleaning");

  // Tests (open DevTools console)
  (function(){
    console.assert(typeof calculate === "function", "[tests] calculate() should exist");
    console.assert(typeof providerApply === "function", "[tests] providerApply() should exist");
    console.assert(typeof submitLeadToNetlify === "function", "[tests] submitLeadToNetlify() should exist");
    console.assert(validateZip("33063") === true, "[tests] validateZip should accept 5 digits");
    console.assert(validateZip("3306") === false, "[tests] validateZip should reject invalid");
    console.assert(document.querySelectorAll(".tab").length === 5, "[tests] should have 5 tabs");

    // Flooring material should affect price
    setCategory("remodel");
    document.getElementById("zip").value = "33063";
    document.getElementById("size").value = "500";
    document.getElementById("service").value = "Flooring";
    refreshConditionalFields();
    document.getElementById("flooringMaterial").value = "Tile";
    const r1 = calculate();
    document.getElementById("flooringMaterial").value = "Carpet";
    const r2 = calculate();
    console.assert(r1 && r2 && r1.low > r2.low, "[tests] carpet should be cheaper than tile");

    // Disposal replacement should return price even if size empty (defaults to 1)
    setCategory("plumbing");
    document.getElementById("zip").value = "33063";
    document.getElementById("service").value = "Disposal Replacement";
    refreshConditionalFields();
    document.getElementById("size").value = "";
    const dr = calculate();
    console.assert(dr && dr.low > 0 && dr.high > dr.low, "[tests] disposal replacement should return a valid range");

    // Pet care should not require size input and should vary by option
    setCategory("pet");
    document.getElementById("zip").value = "33063";
    document.getElementById("service").value = "Walking";
    refreshConditionalFields();
    document.getElementById("petCount").value = "1";
    document.getElementById("petOption").value = "walk_30_m";
    const pw1 = calculate();
    document.getElementById("petOption").value = "walk_60_m";
    const pw2 = calculate();
    console.assert(pw1 && pw2 && pw2.low > pw1.low, "[tests] 60-min walk should be more than 30-min walk");
    console.assert(pw1.low > 5, "[tests] pet walk should not be near $1");
  })();
</script>

</body>
</html>
